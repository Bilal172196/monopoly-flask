<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monopoly Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        poppins: ['Poppins', 'sans-serif'],
                    },
                    colors: {
                        monopoly: {
                            red: '#ED1B24',
                            blue: '#0072BC',
                            green: '#00A650',
                            yellow: '#FFF200',
                        },
                    },
                },
            },
        }

        function formatNumber(value) {
            if (value >= 1e9) {
                return (value / 1e9).toFixed(1) + 'B';
            } else if (value >= 1e6) {
                return (value / 1e6).toFixed(1) + 'M';
            } else if (value >= 1e3) {
                return (value / 1e3).toFixed(1) + 'k';
            } else {
                return value;
            }
        }

        function formatGold(value) {
            if (value >= 1e6) {
                return (value / 1e6).toFixed(3) + ' ton';
            } else if (value >= 1e3) {
                return (value / 1e3).toFixed(3) + ' kg';
            } else {
                return value.toFixed(3) + ' g';
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            var balanceElement = document.getElementById('balance');
            if (balanceElement) {
                var balanceValue = parseFloat(balanceElement.dataset.balance);
                balanceElement.textContent = formatNumber(balanceValue) + '';
            }

            var loanElement = document.getElementById('loan');
            if (loanElement) {
                var loanValue = parseFloat(loanElement.dataset.loan);
                loanElement.textContent = formatNumber(loanValue) + '';
            }

            var goldElement = document.getElementById('gold');
            if (goldElement) {
                var goldValue = parseFloat(goldElement.dataset.gold);
                goldElement.textContent = formatGold(goldValue);
            }

            var flashMessages = document.getElementById('flash-messages');
            if (flashMessages) {
                window.setTimeout(function () {
                    flashMessages.style.opacity = 0;
                    window.setTimeout(function () {
                        flashMessages.style.display = 'none';
                    }, 1000);
                }, 2000);
            }
        });

        window.onpageshow = function (event) {
            if (event.persisted) {
                window.location.reload();
            }
        };
    </script>
</head>

<body class="font-poppins bg-gradient-to-br from-monopoly-blue to-monopoly-green min-h-screen flex flex-col">
    <div class="container mx-auto my-10 px-4 flex-grow">
        <h1 class="text-5xl font-extrabold text-center mb-12 text-white drop-shadow-lg">Monopoly Dashboard</h1>

        <!-- Flash messages -->
        <div id="flash-messages">
            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="max-w-md mx-auto mb-6">
                <div
                    class="{% if category == 'success' %}bg-green-100 border-green-500 text-green-700{% elif category == 'danger' %}bg-red-100 border-red-500 text-red-700{% else %}bg-gray-100 border-gray-500 text-gray-700{% endif %} border-l-4 p-4 rounded-lg">
                    {{ message }}
                </div>
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
        </div>

        <!-- User Info Card -->
        <div class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-xl p-8 shadow-2xl mb-12 ">
            <h2 class="text-3xl font-bold text-monopoly-blue mb-4">Welcome, {{ user['name'] }}!</h2>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                    <p class="text-lg font-semibold text-gray-600">Balance</p>
                    <p id="balance" data-balance="{{ user['balance'] }}" class="text-2xl font-bold text-monopoly-green">
                    </p>
                </div>
                <div>
                    <p class="text-lg font-semibold text-gray-600">Gold</p>
                    <p id="gold" data-gold="{{ user['gold'] }}" class="text-2xl font-bold text-yellow-500"></p>
                </div>
                <div>
                    <p class="text-lg font-semibold text-gray-600">Loan</p>
                    <p id="loan" data-loan="{{ user['loan'] }}" class="text-2xl font-bold text-monopoly-red"></p>
                </div>
            </div>
        </div>

        <div class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-xl p-8 shadow-2xl mb-12">
            <h2 class="text-3xl font-bold text-monopoly-blue mb-4">Your Properties</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for deed in deeds %}
                <div class="bg-{{ deed.color }}-100 rounded-xl p-4 shadow-md">
                    <h3 class="text-xl font-bold mb-2">{{ deed.name }}</h3>
                    <p class="text-gray-600">Current Value: PKR {{ deed.price | round | int }}</p>
                    <p class="text-gray-600">Current Rent: PKR {{ deed.rent | round | int }}</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Auction Section -->
        <div id="auction-section"
            class="bg-white bg-opacity-90 backdrop-filter backdrop-blur-lg rounded-xl p-8 shadow-2xl mb-12">
            <h2 class="text-3xl font-bold text-monopoly-blue mb-4">Active Auctions</h2>
            <div id="active-auctions" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <p id="loading-message" class="col-span-full text-center text-gray-600">Loading auctions...</p>
            </div>
        </div>

        <!-- Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            <!-- Gold Shop -->
            <div class="bg-white rounded-xl p-6 shadow-xl transform hover:-translate-y-2 transition-all duration-300">
                <h5 class="text-2xl font-bold text-monopoly-yellow mb-4">Gold Shop</h5>
                <p class="text-gray-600 mb-6">Buy and sell gold.</p>
                <a href="{{ url_for('gold_shop', user=user['name']) }}"
                    class="block w-full py-3 px-4 bg-monopoly-yellow text-white text-center font-bold rounded-lg hover:bg-yellow-400 transition-colors duration-300">Go
                    to Gold Shop</a>
            </div>

            <!-- Transfers -->
            <div class="bg-white rounded-xl p-6 shadow-xl transform hover:-translate-y-2 transition-all duration-300">
                <h5 class="text-2xl font-bold text-monopoly-blue mb-4">Transfers</h5>
                <p class="text-gray-600 mb-6">Transfer funds between users.</p>
                <a href="{{ url_for('transfers', user=user['name']) }}"
                    class="block w-full py-3 px-4 bg-monopoly-blue text-white text-center font-bold rounded-lg hover:bg-blue-600 transition-colors duration-300">Go
                    to Transfers</a>
            </div>

            <!-- Banking -->
            <div class="bg-white rounded-xl p-6 shadow-xl transform hover:-translate-y-2 transition-all duration-300">
                <h5 class="text-2xl font-bold text-monopoly-green mb-4">Banking</h5>
                <p class="text-gray-600 mb-6">Deposit/Withdraw/Loans</p>
                <a href="{{ url_for('banking', user=user['name']) }}"
                    class="block w-full py-3 px-4 bg-monopoly-green text-white text-center font-bold rounded-lg hover:bg-green-600 transition-colors duration-300">Go
                    to Banking</a>
            </div>
        </div>

        <div class="mt-12 text-center">
            <a href="{{ url_for('logout') }}"
                class="inline-block px-8 py-4 bg-monopoly-red text-white font-bold rounded-full hover:bg-red-600 transition-all duration-300 transform hover:scale-105">Logout</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        const user = "{{ user['name'] }}";
        let activeAuctions = {};

        function updateAuctionUI() {
            const auctionsContainer = document.getElementById('active-auctions');
            const loadingMessage = document.getElementById('loading-message');

            if (Object.keys(activeAuctions).length === 0) {
                loadingMessage.textContent = 'No active auctions at the moment.';
                return;
            }

            loadingMessage.style.display = 'none';
            auctionsContainer.innerHTML = '';

            for (const [auctionId, auction] of Object.entries(activeAuctions)) {
                const auctionCard = document.createElement('div');
                auctionCard.className = 'bg-white rounded-xl p-6 shadow-xl';
                auctionCard.innerHTML = `
                    <h3 class="text-xl font-bold mb-2">${auction.deed_name}</h3>
                    <p class="text-gray-600">Current Bid: PKR ${auction.current_bid}</p>
                    <p class="text-gray-600">Highest Bidder: ${auction.highest_bidder || 'None'}</p>
                    <p class="text-gray-600">Time Left: <span id="timer-${auctionId}"></span></p>
                    <input type="number" id="bid-input-${auctionId}" class="mt-2 p-2 border rounded" placeholder="Your bid">
                    <button onclick="placeBid('${auctionId}')" class="mt-2 px-4 py-2 bg-monopoly-blue text-white rounded">Place Bid</button>
                `;
                auctionsContainer.appendChild(auctionCard);

                // Start the timer for this auction
                startTimer(auctionId, new Date(auction.end_time));
            }
        }

        function startTimer(auctionId, endTime) {
            const timerElement = document.getElementById(`timer-${auctionId}`);

            function updateTimer() {
                const now = new Date();
                const timeLeft = endTime - now;

                if (timeLeft > 0) {
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    timerElement.textContent = `${minutes}m ${seconds}s`;
                    setTimeout(updateTimer, 1000);
                } else {
                    timerElement.textContent = 'Auction Ended';
                }
            }

            updateTimer();
        }

        socket.on('auction_ended', (data) => {
            console.log('Auction ended:', data);
            delete activeAuctions[data.auction_id];
            updateAuctionUI();
            if (data.winner) {
                alert(`Auction for ${data.deed_name} ended. Winner: ${data.winner}, Winning Bid: PKR ${data.winning_bid}`);
            } else {
                alert(`Auction for ${data.deed_name} ended. ${data.message}`);
            }
        });

        function placeBid(auctionId) {
            const bidInput = document.getElementById(`bid-input-${auctionId}`);
            const bidAmount = parseFloat(bidInput.value);

            if (isNaN(bidAmount) || bidAmount <= activeAuctions[auctionId].current_bid) {
                alert('Please enter a valid bid higher than the current bid.');
                return;
            }
            console.log('Placing bid:', { auctionId, user, bidAmount });
            socket.emit('place_bid', {
                auction_id: auctionId,
                user: user,
                bid_amount: bidAmount
            });
        }

        socket.on('connect', () => {
            console.log('Connected to server');
            socket.emit('get_active_auctions');
        });

        socket.on('active_auctions', (auctions) => {
            console.log('Received auctions:', auctions);
            if (Array.isArray(auctions)) {
                activeAuctions = auctions.reduce((acc, auction) => {
                    // Parse end_time back to a Date object
                    if (auction.end_time) {
                        auction.end_time = new Date(auction.end_time);
                    }
                    acc[auction._id] = auction;
                    return acc;
                }, {});
            } else {
                console.error('Received non-array auctions:', auctions);
            }
            updateAuctionUI();
        });

        socket.on('auction_update', (auction) => {
            console.log('Received auction update:', auction);
            activeAuctions[auction._id] = auction;
            updateAuctionUI();
        });

        socket.on('auction_ended', (data) => {
            console.log('Auction ended:', data);
            delete activeAuctions[data.auction_id];
            updateAuctionUI();
            alert(`Auction for ${data.deed_name} ended. Winner: ${data.winner}, Winning Bid: PKR ${data.winning_bid}`);
        });


        socket.on('bid_placed', (data) => {
            console.log('Bid placed successfully:', data);
            // Update the UI to reflect the new bid
            if (activeAuctions[data.auction_id]) {
                activeAuctions[data.auction_id].current_bid = data.new_bid;
                activeAuctions[data.auction_id].highest_bidder = data.bidder;
                updateAuctionUI();
            }
        });

        socket.on('bid_error', (data) => {
            console.error('Bid error:', data);
            alert(data.message);
        });

        // Initial fetch of active auctions
        socket.emit('get_active_auctions');
    </script>
</body>

</html>